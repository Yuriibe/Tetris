<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grid Playground</title>
    <style>
        @import url('http://fonts.cdnfonts.com/css/common-pixel');
        @import url('http://fonts.cdnfonts.com/css/tetris');

        body {
            background-color: black;


        }

        #grid {
            width: 500px;
            height: 500px;
            margin: 0 auto;
        }

        #grid .row {
            display: flex;
            width: 500px;
            height: 50px;
        }

        #grid .cell {
            width: 50px;
            height: 50px;
            background: #FFFFFF;
        }

        #grid .cell.blue {
            background: blue;
        }

        button {
            height: 50px;
            width: 100px;
        }

        #score {
            color: #FFFFFF;
            text-align: center;
            font-size: 75px;
            font-family: 'Common Pixel', sans-serif;
        }

        #title {
            color: white;
            font-family: 'Tetris', sans-serif;
            text-align: center;
        }
    </style>
</head>
<body onclick="music()">
<h1 id="title"><span id=titleT" style="color: #fc3450">T
    <span id="titleE" style="color:#fe8f12 ">E
        <span id="titleT2" style="color: #ffd523">T
            <span id="titleR" style="color: #5ddf3f">R
                <span id="titleI" style="color:#1ff1ff ">I
                    <span id="titleS" style="color: #f52bf7">S
                    </span>
                </span>
            </span>
        </span>
    </span>
</span>
</h1>
<div id="grid">
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>

</div>
<audio src="../Pictures_Sound/tetris.mp3"></audio>
<div id="score">0</div>
<script>
    const iBlock = {
        type: "i",
        shape: [
            [1, 1, 1, 1],
            [0, 0, 0, 0]
        ]
    }
    const sBlock = {
        type: "s",
        shape: [
            [0, 1, 1, 0],
            [1, 1, 0, 0]
        ]
    }
    const zBlock = {
        type: "z",
        shape: [
            [1, 1, 0, 0],
            [0, 1, 1, 0]
        ]
    }
    const lBlock = {
        type: "l",
        shape: [
            [0, 0, 1, 0],
            [1, 1, 1, 0]
        ]
    }
    const jBlock = {
        type: "j",
        shape: [
            [1, 0, 0, 0],
            [1, 1, 1, 0]
        ]
    }
    const tBlock = {
        type: "t",
        shape: [
            [0, 1, 0, 0],
            [1, 1, 1, 0]
        ]
    }
    const oBlock = {
        type: "o",
        shape: [
            [1, 1, 0, 0],
            [1, 1, 0, 0]
        ]
    }

    var grid = generateGridArray();
    console.log(grid);

    function colorCell(cell, color) {
        cell.style.background = color;
        return cell.style.background;

    }

    function reset(cell) {
        if (cell !== undefined) {
            return cell.style.background;
        }
    }

    function getColorCell(cell) {
        if (cell !== undefined) {
            return cell.style.background;
        }
        return '';
    }

    function generateGridArray() {
        var cells = document.querySelectorAll('.cell');
        var grid = [];

        for (var i = 0; i < cells.length; i++) {
            var cell = cells[i];
            var x = (i % 10);
            var y = Math.floor(i / 10);

            // Wenn in noch kein Array in grid[x] initialisiert wurde, tun wir das.
            if (!grid[x]) {
                grid[x] = [];
            }
            grid[x][y] = cell;
        }
        return grid;
    }


    const farbe = ["#00f1f1", "#00008b", "#efa002", "#efa002", "#00f000", "#00f000", "#f00100"]
    var colorRandom = farbe[Math.floor(Math.random() * farbe.length)];
    var score = 0;
    var sleepSec = 0.5
    var allPieces =[
        oBlock,
        tBlock,
        zBlock,
        sBlock,
        jBlock,
        lBlock,
        iBlock
    ];
    var randomPieces = allPieces[Math.floor(Math.random() * allPieces.length)];


    test();
    music();



    function test() {
        x = 0
        y = 0
        while (x < 4) {
            if (randomPieces.shape[y][x] == 1) {
                colorCell(grid[x][y], "#00008b")
                x++;
                console.log(x)
            } else {
                x++
                console.log(x)
            }
            if (x == 4) {
                x = 0;
                y++
            }
        }
    }

    async function moveBlock() {
        var y = 0;
        var x = 0;

        while (y < 10 && x < 10 && x >= 0) {
            if (getColorCell(grid[x][y]) == "") {                   // guckt ob die Zelle leer (weiß) ist
                colorCell(grid[x][y], colorRandom);               // Wenn die Zelle leer ist, wird sie gefärbt
                if (y > 0) {                                     // Wenn i größer als 0 ist (also wenn das erste feld gefärbt wurde)
                    colorCell(grid[x][y - 1], "");              //dann setze das vorherige feld wieder weiß
                }
                y++;
                await sleep(sleepSec);
                if (y == 10 || getColorCell(grid[x][y]) !== "") {               // wenn der Block unten angekommen ist oder Kollidiert
                    y = 0;                                                     // setze i auf 0 und fange von vorne an(neuer block fällt)
                    //x = 0;
                    //x = Math.floor(Math.random() * 10);
                    x = x + 1
                    if (x == 10) {
                        x = 0;
                    }
                }
                if (getColorCell(grid[x][1]) !== "" && getColorCell(grid[x][0]) !== "") { // wenn die 2 letzten felder gefärbt sind ist game over
                    gameOver();
                }
            }
            document.onkeydown = (e) => { // move BlockLeft
                var e = e || window.event;
                if (e.key === 'ArrowLeft') { // wenn Linke taste gedrückt dann
                    if (y < 10 && x >= 0) {             // verhindert verschwinden des blockes
                        if (getColorCell(grid[x - 1][y]) == "") { // verhindert verschwinden des blockes
                            var savey = y;
                            var savex = x;
                            if (x > 0) {                         // guckt ob am rand angekommen
                                x = x - 1;                       //
                                colorCell(grid[savex][savey - 1], "");
                            }
                        }
                    }
                }
                if (e.key === "ArrowRight") {
                    if (y < 10) {
                        if (getColorCell(grid[x + 1][y]) == "") {
                            var savey = y;
                            var savex = x;
                            if (x < 9) {
                                x = x + 1;
                                colorCell(grid[savex][savey - 1], "");
                            }
                        }
                    }
                }
                if (e.key === "ArrowDown") {
                    sleepSec = 0.05;
                    document.onkeyup = (e2) => {
                        var e = e || window.event;
                        if (e2.key === "ArrowDown") {
                            sleepSec = 0.5;
                        }
                    }
                }
            }
        }


    }


    setInterval(clearRows, 500);

    function clearRows() {
        var checkx1 = 0;
        var checky1 = 9;
        var coloredConsecutive = 0;
        var i = 0;
        while (checkx1 < 10) {
            if (getColorCell(grid[checkx1][checky1]) !== "") {
                checkx1++;
                coloredConsecutive++;
                if (coloredConsecutive == 10) {
                    while (i < 10) {
                        colorCell(grid[i][checky1], "");
                        i++;
                    }
                    coloredConsecutive = 0;
                    moveRows()
                    score = score + 100;
                    document.getElementById("score").innerHTML = score;

                }

            } else {
                checky1--;
                break;
            }

        }


        function moveRows() {
            var checkx3 = 0;
            var checky3 = 9;
            while (checkx3 < 10 && checky3 >= 0) {
                if (getColorCell(grid[checkx3][checky3]) !== "") {
                    if (getColorCell(grid[checkx3][checky3 + 1]) == "") {
                        colorCell(grid[checkx3][checky3 + 1], colorRandom);
                        colorCell(grid[checkx3][checky3], "");

                    }
                }
                checkx3++;
                if (checkx3 > 9) {
                    checky3--;
                    checkx3 = 0;

                }


            }
        }
    }


    function gameOver() {
        if (confirm("Game over, You suck! \n Willst  nochmal spielen?")) { // Gameover "Screen" + neu start frage
            var yClear = 9;
            var xClear = 9;
            score = 0;
            document.getElementById("score").innerHTML = score;
            while (xClear > 0) { // säubern des Spielfeldes von links nach rechts und immer +1 nach unten;
                colorCell(grid[xClear][yClear], "")  //
                xClear--;
                if (xClear == 0 && yClear >= 0) {
                    colorCell(grid[xClear][yClear], "")
                    if (xClear == 0 && yClear != 0) {
                        yClear--;
                        xClear = 9;
                    }
                }
            }
        }
    }

    function music() {
        window.addEventListener("DOMContentLoaded", event => {
            const audio = document.querySelector("audio");
            audio.volume = 1;
            muted = false;
            autoplay = true;
            audio.play();
        });

    }

    async function sleep(seconds) {
        return new Promise(resolve => setTimeout(resolve, seconds * 1000))
    }

    function test2(){
        alert(checky1)
    }

    function collision(moveX, moveY) {
        var iY = 0;
        var jX = 0;
        while (jX < allForms[ramdomNmbr][RotationValue].shape[0].length && iY < allForms[ramdomNmbr][RotationValue].shape.length) {
            if (iY == allForms[ramdomNmbr][RotationValue].shape.length - 1) { // Letzte Reihe
                if (allForms[ramdomNmbr][RotationValue].shape[iY][jX] == 0) { // dont care for collision
                } else if (allForms[ramdomNmbr][RotationValue].shape[iY][jX] == 1) {// care for collision
                    console.warn("else if")
                    if (getColorCell(grid[x + jX + moveX][y + iY + moveY]) !== "" || grid[x + jX + moveX][y + iY + moveY] == grid[0].length - 1) {
                        console.info("collision if" + iY + jX + allForms[ramdomNmbr][RotationValue].shape[iY][jX])
                        return true;

                    }
                }
                jX++;
            } else {
                if (iY !== allForms[ramdomNmbr][RotationValue].shape.length - 1 && allForms[ramdomNmbr][RotationValue].shape[iY + moveY][jX + moveX] == 1) { // dont care for collision
                } else if (allForms[ramdomNmbr][RotationValue].shape[iY + moveY][jX + moveX] == 0 && allForms[ramdomNmbr][RotationValue].shape[iY][jX] == 1) {// care for collision
                    if (getColorCell(grid[x + jX + moveX][y + iY + moveY]) !== "" || grid[x + jX + moveX][y + iY + moveY] == grid[0].length) { // Check if can colide
                        console.info("collision else " + iY + jX + allForms[ramdomNmbr][RotationValue].shape[iY][jX]); // colided
                        return true;

                    }
                }
                jX++;
                if (jX == allForms[ramdomNmbr][RotationValue].shape[0].length) { // if right side of array is reached, go one row down
                    iY++;
                    jX = 0;
                }
            }

        }
        return false;
    }


</script>
</body>
</html>