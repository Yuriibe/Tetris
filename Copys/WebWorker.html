<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tetris Playground</title>
    <style>
        @import url('http://fonts.cdnfonts.com/css/common-pixel');
        @import url('http://fonts.cdnfonts.com/css/tetris');

        body {
            background-color: black;
        }

        #grid {
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        #grid .row {
            display: flex;
            width: 300px;
            height: 30px;
        }

        #grid .cell {
            width: 30px;
            height: 30px;
            background: #FFFFFF;
        }

        #grid .cell.blue {
            background: blue;
        }

        #score {
            color: #FFFFFF;
            margin-left: 250px;
            font-size: 75px;
            font-family: 'Common Pixel', sans-serif;
        }

        #title {
            color: white;
            font-family: 'Tetris', sans-serif;
            text-align: center;
        }
    </style>
</head>
<body onclick="music()">
<h1 id="title"><span id=titleT" style="color: #fc3450">T
    <span id="titleE" style="color:#fe8f12 ">E
        <span id="titleT2" style="color: #ffd523">T
            <span id="titleR" style="color: #5ddf3f">R
                <span id="titleI" style="color:#1ff1ff ">I
                    <span id="titleS" style="color: #f52bf7">S
                    </span>
                </span>
            </span>
        </span>
    </span>
</span>
</h1>
<div id="grid">
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
</div>
<audio src="../Pictures_Sound/tetris.mp3"></audio>
<div id="score">0</div>
<script>
    const iBlock = {
        type: "i",
        shape: [
            [0, 0, 0, 0],
            [1, 1, 1, 1]
        ]
    }
    const sBlock = {
        type: "s",
        shape: [
            [0, 1, 1, 0],
            [1, 1, 0, 0]
        ]
    }
    const zBlock = {
        type: "z",
        shape: [
            [1, 1, 0, 0],
            [0, 1, 1, 0]
        ]
    }
    const lBlock = {
        type: "l",
        shape: [
            [0, 0, 1, 0],
            [1, 1, 1, 0]
        ]
    }
    const jBlock = {
        type: "j",
        shape: [
            [1, 0, 0, 0],
            [1, 1, 1, 0]
        ]
    }
    const tBlock = {
        type: "t",
        shape: [
            [0, 1, 0, 0],
            [1, 1, 1, 0]
        ]
    }
    const oBlock = {
        type: "o",
        shape: [
            [1, 1, 0, 0],
            [1, 1, 0, 0]
        ]
    }

    var grid = generateGridArray();
    console.log(grid);

    function colorCell(cell, color) {
        cell.style.background = color;
        return cell.style.background;

    }

    function reset(cell) {
        if (cell !== undefined) {
            return cell.style.background;
        }
    }

    function getColorCell(cell) {
        if (cell !== undefined) {
            return cell.style.background;
        }
        return '';
    }

    function generateGridArray() {
        var cells = document.querySelectorAll('.cell');
        var grid = [];
        var x = 0;
        var y = 0;
        for (var i = 0; i < cells.length; i++) {
            var cell = cells[i];

            //var x = (i % 10);
            //var y = Math.floor(i / 10);
            // Wenn in noch kein Array in grid[x] initialisiert wurde, tun wir das.
            if (!grid[x]) {
                grid[x] = [];
            }
            grid[x][y] = cell;
            x++;
            if (x > 9) {
                x = 0;
                y++;
            }
        }
        return grid;


    }

    const farbe = ["#00f1f1", "#00008b", "#efa002", "#efa002", "#00f000", "#00f000", "#f00100"]
    var score = 0;
    var sleepSec = 0.5
    var allPieces = [
        oBlock,
        tBlock,
        zBlock,
        sBlock,
        jBlock,
        lBlock,
        iBlock
    ];


    blockFällt(0, 0);
    random();
    music();


    function random() {
        globalThis.randomPieces = allPieces[Math.floor(Math.random() * allPieces.length)];
        //globalThis.randomPieces = oBlock;
        globalThis.colorRandom = farbe[Math.floor(Math.random() * farbe.length)];
        //var currentblock = randomPieces;
    }

    function drawBlock(x, y) {
        i = 0;
        j = 0;
        while (j < 4 && i < 2) {
            console.log(x)
            if (randomPieces.shape[i][j] == 1) {
                colorCell(grid[x + j][y + i], colorRandom)
                j++;
            } else {
                j++;
            }
            if (j == 4) {
                j = 0;
                i++;
            }
        }
    }


    function removeBlock(x, y) {
        i = 0;
        j = 0;
        while (j < 4 && i < 2) {
            //console.log(i)
            if (randomPieces.shape[i][j] == 1) {
                colorCell(grid[x + j][y + i], "")
                j++;
            } else {
                j++;
            }
            if (j == 4) {
                j = 0;
                i++;
            }
        }
    }

    async function blockFällt(x, y) {
        i = 0;
        while (y < grid[0].length) {
            await sleep(sleepSec)
            if (i == 0) {
                drawBlock(x, y);
                await sleep(sleepSec)
                i++;
            }
            if (i > 0 && y < grid[0].length || getColorCell(grid[x][y + 2] == "")) {
                removeBlock(x, y);
                drawBlock(x, y + 1);
            }
            y++;
            if (getColorCell(grid[x][y + 2]) !== "" || y == grid[0].length - 2) { // Position check + Kollision
                x = 0;
                y = 0;
                i = 0;

                random();
                if (getColorCell(grid[x][0]) !== "") { // wenn die 2 letzten felder gefärbt sind ist game over
                    gameOver();
                }
            }
            document.onkeydown = (e) => { // move BlockLeft
                var e = e || window.event;
                if (e.key === 'ArrowRight') {
                    if (y < grid[0].length || getColorCell(grid[x + 1][y] == "")) {
                        if (x < 10) {
                            removeBlock(x, y)
                            drawBlock(x + 1, y)
                            x++;
                        }
                    }
                }
                var e = e || window.event;
                if (e.key === 'ArrowLeft') {
                    if (y < grid[0].length || getColorCell(grid[x - 1][y] == "")) {
                        if (x > 0) {
                            removeBlock(x, y)
                            drawBlock(x - 1, y)
                            x--;
                        }
                    }
                }
                if (e.key === "ArrowDown") {
                    sleepSec = 0.05;
                    document.onkeyup = (e2) => {
                        var e = e || window.event;
                        if (e2.key === "ArrowDown") {
                            sleepSec = 0.5;
                            // y = grid[0].length - 3; // place block in last row
                        }
                    }
                }
            }
        }
        if (getColorCell(grid[x][0]) !== "") { // wenn die 2 letzten felder gefärbt sind ist game over
            alert(getColorCell(grid[x][0]));
            gameOver();
        }
    }


    setInterval(clearRows, 500);

    function clearRows() {
        var checkx1 = 0;
        var checky1 = grid[0].length - 1;
        var coloredConsecutive = 0;
        var i = 0;
        while (checkx1 < 10) {
            if (getColorCell(grid[checkx1][checky1]) !== "") {
                checkx1++;
                coloredConsecutive++;
                if (coloredConsecutive == 10) {
                    while (i < 10) {
                        colorCell(grid[i][checky1], "");
                        i++;
                    }
                    coloredConsecutive = 0;
                    moveRows()
                    score = score + 100;
                    document.getElementById("score").innerHTML = score;

                }

            } else {
                checky1--;
                break;
            }

        }


        function moveRows() {
            var checkx3 = 0;
            var checky3 = grid[0].length - 1;
            while (checkx3 < 10 && checky3 >= 0) {
                if (getColorCell(grid[checkx3][checky3]) !== "") {
                    if (getColorCell(grid[checkx3][checky3 + 1]) == "") {
                        colorCell(grid[checkx3][checky3 + 1], colorRandom);
                        colorCell(grid[checkx3][checky3], "");

                    }
                }
                checkx3++;
                if (checkx3 > 9) {
                    checky3--;
                    checkx3 = 0;

                }


            }
        }
    }


    function gameOver() {
        if (confirm("Game over, You suck! \n Willst  nochmal spielen?")) { // Gameover "Screen" + neu start frage
            var yClear = grid[0].length - 1;
            var xClear = 9;
            score = 0;
            document.getElementById("score").innerHTML = score;
            while (xClear > 0) { // säubern des Spielfeldes von links nach rechts und immer +1 nach unten;
                colorCell(grid[xClear][yClear], "")  //
                xClear--;
                if (xClear == 0 && yClear >= 0) {
                    colorCell(grid[xClear][yClear], "")
                    if (xClear == 0 && yClear != 0) {
                        yClear--;
                        xClear = 9;
                        test3 = 0;
                        y = 0;
                    }
                }
            }
        }
    }

    function music() {
        window.addEventListener("DOMContentLoaded", event => {
            const audio = document.querySelector("audio");
            audio.volume = 1;
            muted = false;
            autoplay = true;
            audio.play();
        });

    }

    async function sleep(seconds) {
        return new Promise(resolve => setTimeout(resolve, seconds * 1000))
    }

</script>
</body>
</html>